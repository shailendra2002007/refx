sap.ui.define(["dewa/refx/accommodation/controller/BaseController","sap/suite/ui/commons/TimelineItem","sap/m/UploadCollectionParameter","sap/m/UploadCollectionItem","sap/m/ObjectAttribute"],function(e,t,i,o,r){"use strict";return e.extend("dewa.refx.accommodation.controller.Worklist",{onContractStartDateChange:function(e){if(!e.getParameters().valid){e.getSource().setDateValue();return this.oMessage.error(this.getResourceBundle().getText("MSG_INVALID_CONTRACT_START_DATE"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center"})}},onClickOnRequiredFile:function(e){try{var t=encodeURI("/sap/opu/odata/sap/ZREFX_GD_ACCOMMODATION_SRV/getDMSDocumentSet('"+e.getSource().getCustomData()[0].getValue()+"')/$value");window["dewa.refx.accommodation"].downloadFile(t,e.getSource().getText())}catch(e){jQuery.sap.log.error(e)}},onInit:function(){this.baseControlleronInit();this.getRouter().getRoute("create").attachPatternMatched(this.onCreatePatternMatched,this);this.getRouter().getRoute("worklist").attachPatternMatched(this.onViewPatternMatched,this);this.getRouter().getRoute("workitem").attachPatternMatched(this.onViewPatternMatchedThroughPortal,this)},onCreatePatternMatched:function(){if(!this.getModel().isMetadataLoadingFailed()){try{window["dewa.refx.accommodation"].currentView=this.getView();this.refreshModelData();this.getModel("worklistView").setProperty("/sProcessType","createRequest");if(this.getOwnerComponent().getModel("routerDetails")){this.getCreateAccommodationData(this.getOwnerComponent().getModel("routerDetails").getData().selectedItem)}else{this.getRouter().navTo("inbox")}}catch(e){this.closeBusyDialog();this.exceptionErrorNavToMainPage(e)}}},formatter_returnLowerCaseAgent:function(e){if(e){return this.getResourceBundle().getText(e.toLowerCase().replace(" ","_"))}else{return""}},onViewPatternMatchedThroughPortal:function(e){sap.ui.core.UIComponent.getRouterFor(this).stop();if(!this.getModel().isMetadataLoadingFailed()){try{window["dewa.refx.accommodation"].currentView=this.getView();this.refreshModelData();this.getView().getModel("worklistView").setProperty("/bAgreement",true);this.getView().getModel("worklistView").setProperty("/sProcessType","viewRequest");if(!e.getParameter("arguments").WorkItemNo){if(this.getRouter().getHashChanger().hash.indexOf("myportal/")!==-1){var t=this.getRouter().getHashChanger().hash.indexOf("myportal/");var i=t+9;t=this.getRouter().getHashChanger().hash.substring(i,i+12)}}else if(e.getParameter("arguments").WorkItemNo){t=e.getParameter("arguments").WorkItemNo}this.WorkItemNo=t;this.fetchApplicationControlData().then(this.fetchRequiredDocumentDetails.bind(this),null).then(this.getUserDetails.bind(this),null).then(this.getAccommodationDetailsThroughPortal.bind(this),this.errorWhileFetchinUserDetails.bind(this))}catch(e){return this.oMessage.error(this.getResourceBundle().getText("MSG_FETCHIN_WI"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",details:"<p><strong>Solution:</strong></p>\n"+"Please try opening the link again from your portal inbox.."+"<p class='msgSubText'>Please note. This window will be closed after this message..</p>",onClose:function(){location.reload()}.bind(this),actions:sap.m.MessageBox.Action.OK})}}},getAccommodationDetailsThroughPortal:function(){this.getAccommodationRelatedDetailsThroughPortal(new this.oFilters({path:"WorkItemNo",value1:this.WorkItemNo,operator:this.oFilterOperator.EQ})).then(function(){this.clearPromises();if(this.getView().getModel("worklistView").getProperty("/Accommodation/BldngNo")&&this.getView().getModel("worklistView").getProperty("/Accommodation/BusEntityNo")){this.fetchingFlatType();this.updateRequiredFile()}if(this.getView().getModel("worklistView").getProperty("/Accommodation/BusType")===this.getResourceBundle().getText("GD")&&this.getView().getModel("worklistView").getProperty("/Accommodation/FlatType").charAt(0)==="Z"&&this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("BUILDING_ADMINISTRATOR")&&this.getView().getModel("worklistView").getProperty("/Accommodation/BldngNo")!==""||this.getView().getModel("worklistView").getProperty("/Accommodation/BusType")===this.getResourceBundle().getText("GD")&&this.getView().getModel("worklistView").getProperty("/Accommodation/FlatType").charAt(0)==="Z"&&this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("DEPUTY_MANAGER")&&this.getView().getModel("worklistView").getProperty("/Accommodation/BldngNo")!==""||this.getView().getModel("worklistView").getProperty("/Accommodation/BusType")===this.getResourceBundle().getText("GD")&&this.getView().getModel("worklistView").getProperty("/Accommodation/FlatType").charAt(0)==="Y"&&this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("DEPUTY_MANAGER")&&this.getView().getModel("worklistView").getProperty("/Accommodation/BldngNo")!==""||this.getView().getModel("worklistView").getProperty("/Accommodation/BusType")===this.getResourceBundle().getText("BS")&&this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("BUILDING_ADMINISTRATOR")&&this.getView().getModel("worklistView").getProperty("/Accommodation/BldngNo")!==""){this.fetchingRentalUnit()}}.bind(this),null)},errorWhileFetchinUserDetails:function(){this.closeBusyDialog();this.noErrorhandling();return this.oMessage.error(this.getResourceBundle().getText("USERDETAILSERROR"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",details:"<p><strong>Solution:</strong></p>\n"+"Please go to main page and try again.."+"<p class='msgSubText'>Please note. User will be navigated back to the main page after this message.</p>",onClose:function(){this.getOwnerComponent().getRouter().navTo("inbox")}.bind(this),actions:sap.m.MessageBox.Action.OK})},onViewPatternMatched:function(){if(!this.getModel().isMetadataLoadingFailed()){try{window["dewa.refx.accommodation"].currentView=this.getView();this.refreshModelData();this.getView().getModel("worklistView").setProperty("/sProcessType","viewRequest");this.getView().getModel("worklistView").setProperty("/bAgreement",true);if(this.getOwnerComponent().getModel("routerDetails")){this.getAccommodationData(this.getOwnerComponent().getModel("routerDetails").getData().selectedItem).then(function(){this.clearPromises();if(this.getView().getModel("worklistView").getProperty("/Accommodation/BldngNo")&&this.getView().getModel("worklistView").getProperty("/Accommodation/BusEntityNo")){this.fetchingFlatType();this.updateRequiredFile()}if(this.getView().getModel("worklistView").getProperty("/Accommodation/BusType")===this.getResourceBundle().getText("GD")&&this.getView().getModel("worklistView").getProperty("/Accommodation/FlatType").charAt(0)==="Z"&&this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("BUILDING_ADMINISTRATOR")&&this.getView().getModel("worklistView").getProperty("/Accommodation/BldngNo")!==""||this.getView().getModel("worklistView").getProperty("/Accommodation/BusType")===this.getResourceBundle().getText("GD")&&this.getView().getModel("worklistView").getProperty("/Accommodation/FlatType").charAt(0)==="Z"&&this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("DEPUTY_MANAGER")&&this.getView().getModel("worklistView").getProperty("/Accommodation/BldngNo")!==""||this.getView().getModel("worklistView").getProperty("/Accommodation/BusType")===this.getResourceBundle().getText("GD")&&this.getView().getModel("worklistView").getProperty("/Accommodation/FlatType").charAt(0)==="Y"&&this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("DEPUTY_MANAGER")&&this.getView().getModel("worklistView").getProperty("/Accommodation/BldngNo")!==""||this.getView().getModel("worklistView").getProperty("/Accommodation/BusType")===this.getResourceBundle().getText("BS")&&this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("BUILDING_ADMINISTRATOR")&&this.getView().getModel("worklistView").getProperty("/Accommodation/BldngNo")!==""){this.fetchingRentalUnit()}}.bind(this),function(){this.clearPromises()}.bind(this))}else{this.getRouter().navTo("inbox")}}catch(e){this.closeBusyDialog();this.exceptionErrorNavToMainPage(e)}}},fetchingFlatType:function(){this.openBusyDialog(this.getResourceBundle().getText("LOADING_FLATTYPE"));this.getView().getModel().read("/FlatTypesF4Set",{filters:[new this.oFilters({path:"BusEntityNo",operator:this.oFilterOperator.EQ,value1:this.getView().getModel("worklistView").getProperty("/Accommodation/BusEntityNo")}),new this.oFilters({path:"BldngNo",operator:this.oFilterOperator.EQ,value1:this.getView().getModel("worklistView").getProperty("/Accommodation/BldngNo")})],success:function(e){try{if(!e.results.length){if(this.getView().getModel("flatType")){this.getView().getModel("flatType").setData(null);this.getModel("worklistView").setProperty("/Accommodation/FlatTypeText","");this.getModel("worklistView").setProperty("/Accommodation/FlatType","")}return this.oMessage.error(this.getResourceBundle().getText("NO_FLAT_TYPE"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center"})}else{this.getView().setModel(new this.oJson(e.results),"flatType")}}catch(e){if(this.getView().getModel("flatType")){this.getView().getModel("flatType").setData(null);this.getModel("worklistView").setProperty("/Accommodation/FlatTypeText","");this.getModel("worklistView").setProperty("/Accommodation/FlatType","")}return this.oMessage.error(this.getResourceBundle().getText("NO_FLAT_TYPE"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center"})}finally{if(!this.byId("flatTypeCB").getSelectedItem()){this.byId("flatTypeCB").fireChange({selectedItem:this.byId("flatTypeCB").getFirstItem()})}else{this.byId("flatTypeCB").fireChange({selectedItem:this.byId("flatTypeCB").getSelectedItem()})}this.closeBusyDialog()}}.bind(this),error:function(){this.closeBusyDialog();this.noErrorhandling();return this.oMessage.error(this.getResourceBundle().getText("MSG_FLAT_TYPE"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",onClose:function(){}.bind(this)})}.bind(this)})},fetchingRentalUnit:function(){this.openBusyDialog(this.getResourceBundle().getText("LOADING_RENTALUNIT"));this.getView().getModel().read("/RentalUnitSet",{filters:[new this.oFilters({path:"BldngNo",operator:this.oFilterOperator.EQ,value1:this.getView().getModel("worklistView").getProperty("/Accommodation/BldngNo")}),new this.oFilters({path:"BusEntityNo",operator:this.oFilterOperator.EQ,value1:this.getView().getModel("worklistView").getProperty("/Accommodation/BusEntityNo")}),new this.oFilters({path:"FlatTypeCode",operator:this.oFilterOperator.EQ,value1:this.getView().getModel("worklistView").getProperty("/Accommodation/FlatType")?this.getView().getModel("worklistView").getProperty("/Accommodation/FlatType").toString():""})],success:function(e){try{var t=e.results.filter(function(e){return e.RentalObject===this.getView().getModel("worklistView").getProperty("/Accommodation/RentalObject")||e.AssignedRequest===""}.bind(this));var i=new this.oJson(t);i.setSizeLimit(t.length);this.getView().setModel(i,"rentalUnit")}catch(e){this.oMessage.error(this.getResourceBundle().getText("NO_RENTAL_UNIT"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center"})}finally{this.closeBusyDialog()}}.bind(this),error:function(e){this.closeBusyDialog();this.noErrorhandling();this.oMessage.error(this.getResourceBundle().getText("MSG_RENTAL_UNIT"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",onClose:function(){}.bind(this)})}.bind(this)})},postingCommentsInModel:function(e,t){try{if(this.getView().getModel("worklistView").getProperty("/Accommodation/Received_Comments")===""){this.getView().getModel("worklistView").setProperty("/Accommodation/Received_Comments","No comments were entered.")}var i=this.getView().getModel("worklistView").getData();if(i.Accommodation.Comments===undefined){i.Accommodation.Comments={results:[]}}var o=this.getOwnerComponent().getModel("userDetails").getProperty("/loggedInUser/headerDetails");var r;if(this.getView().getModel("worklistView").getProperty("/sProcessType")==="createRequest"){r=this.getResourceBundle().getText("initiator")}else if(this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")!==undefined){r=this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept").toLowerCase()}i.Accommodation.Comments.results.push({BusType:o.BusType,PayrollNo:o.PayrollNo,ReqNo:o.ReqNo,TDFORMAT:"cmtsEnteredinApplication",TDLINE:o.UserID+"|"+o.PayrollFullName+"|"+o.PayrollNo+"|"+r+"|"+(new moment).format("HHmmSS")+"|"+(new moment).format("YYYYMMDD")+"|"+t.Status});i.Accommodation.Comments.results.push({BusType:o.BusType,PayrollNo:o.PayrollNo,ReqNo:o.ReqNo,TDFORMAT:"",TDLINE:this.getView().getModel("worklistView").getProperty("/Accommodation/Received_Comments")});t.Comments.results=i.Accommodation.Comments.results;return t}catch(e){return t}},onChangeComments:function(e){this.getView().getModel("worklistView").setProperty("/Accommodation/Received_Comments",e.getSource().getValue())},factory_constructingCmtsItems2:function(e,t){var i=t.getModel().getProperty(t.getPath()).TDLINE;if(t.getModel().getProperty(t.getPath()).TDLINE.indexOf("|")!==-1&&t.getModel().getProperty(t.getPath()).TDFORMAT===":"){var o=i.split("|");var r;var s;var n;var a;a=o[6];switch(true){case o[6]==="Approved":s="Success";n="sap-icon://hr-approval";break;case o[6]==="Rejected":s="Error";n="sap-icon://employee-rejections";break;case o[6]==="Waitlisted":s="Error";n="sap-icon://customer-history";break;case o[6]==="Submitted":s="Success";n="sap-icon://activity-individual";break;case o[6]==="Needs Clarification"||o[6]==="Clarify":s="Warning";n="sap-icon://employee-lookup";break;case o[6]==="Clarified":s="Success";n="sap-icon://supplier";break;default:s="Success";n="sap-icon://person-placeholder"}var l=new this.oFeedListItem({customData:new this.oCustomData({key:"userRole",value:o[3]}),moreLabel:"more",lessLabel:"less",icon:n,info:this.getResourceBundle().getText(o[3].toLowerCase().replace(" ","_")),sender:o[1],senderActive:false,iconActive:false,timestamp:new moment(o[5]+o[4],"YYYYMMDDHHmmSS").format("MMM DD, yyyy")});var g=this.getView().getModel("worklistView").getData().Accommodation.Comments.results;if(Number(t.getPath().split("/")[t.getPath().split("/").length-1])+1===g.length){if(g[Number(t.getPath().split("/")[t.getPath().split("/").length-1])].TDLINE.indexOf("|")!==-1&&g[Number(t.getPath().split("/")[t.getPath().split("/").length-1])].TDFORMAT===":"){l.setText("No comments were entered.");return l}}for(var c=Number(t.getPath().split("/")[t.getPath().split("/").length-1])+1;c<g.length;c++){if(g[c].TDLINE.indexOf("|")!==-1&&g[c].TDFORMAT===":"){if(r!==undefined){if(r.indexOf("\\n")!==-1){r="\\n"+r}}else{r="No comments were entered."}l.setText(r.replaceAll("\\n","<br />"));return l}else{if(r===undefined){r=g[c].TDLINE}else{r=r+" "+g[c].TDLINE}if(c===g.length-1){if(r.indexOf("\\n")!==-1){r="\\n"+r}l.setText(r.replaceAll("\\n","<br />"));return l}continue}}}else{return new this.oFeedListItem({visible:false})}},onConfirmUndertaking:function(e){if(this.getModel("worklistView")&&this.getModel("worklistView").getProperty("/Accommodation/BusType")===""){e.getSource().setSelected(false);return this.oMessage.error(this.getResourceBundle().getText("MSG_BUILDING_ERROR"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",details:"<p><strong>Solution:</strong></p>\n"+"Please select the building in the request data section."+"<p class='msgSubText'>Please note. User will be navigated back to request data section after this message.</p>",onClose:function(){this.getView().byId("objectLayout").scrollToSection(this.getView().byId("buildingDetails").getId(),500)}.bind(this),actions:sap.m.MessageBox.Action.OK})}this.getView().byId("objectLayout").scrollToSection(this.getView().byId("policiesDetails").getId(),500)},getAccommodationData:function(e){return new Promise(function(t,i){this.resolve=t;this.reject=i;this.openBusyDialog(this.getResourceBundle().getText("LOADING_REQUESTDETAILS"));try{this.getView().getModel("worklistView").setProperty("/Accommodation",e);this.getView().getModel("worklistView").setProperty("/Accommodation/Received_Comments","");if(Number(e.ReqNo)>0){this.getAccommodationRelatedDetails(new this.oFilters({path:"ReqNo",value1:e.ReqNo,operator:this.oFilterOperator.EQ}))}else{this.resolve()}}catch(e){this.reject();this.closeBusyDialog();this.exceptionErrorNavToMainPage(e)}}.bind(this))},getCreateAccommodationData:function(e){this.openBusyDialog(this.getResourceBundle().getText("LOADING_REQUESTDETAILS"));try{this.getView().getModel("worklistView").setProperty("/Accommodation",e);this.getView().getModel("worklistView").setProperty("/Accommodation/Received_Comments","");this.closeBusyDialog()}catch(e){this.closeBusyDialog();this.exceptionErrorNavToMainPage(e)}},getAccommodationRelatedDetailsThroughPortal:function(e){return new Promise(function(t,i){this.openBusyDialog(this.getResourceBundle().getText("LOADING_REQUESTDETAILS"));this.getView().getModel().read("/AccommodationSet(BusType='',ReqNo='',PayrollNo='')",{filters:[e],urlParameters:{$expand:"Workitem,Workitem/Activity,Comments,Logs,Attachment"},success:function(e){try{this.closeBusyDialog();if(e.Attachment&&e.Attachment.results){e.Attachment.results.sort(function(e,t){var i=t.Att_txt.split(";")[t.Att_txt.split(";").length-1];var o=t.Att_txt.split(";")[t.Att_txt.split(";").length-2];var r=e.Att_txt.split(";")[t.Att_txt.split(";").length-2];var s=t.Att_txt.split(";")[t.Att_txt.split(";").length-1];return new moment(i+o,"YYYYMMDDHHmmSS").toDate()-new moment(s+r,"YYYYMMDDHHmmSS").toDate()});for(var o=e.Attachment.results.length-1;o>=0;o--){var r=e.Attachment.results[o].Att_txt.split(";")[0].split("(")[1].split(")")[0];if(e.Workitem.Agent_dept===""||e.Workitem.Agent_dept===this.getView().getModel("i18n").getProperty("INITIATOR")||e.Workitem.Agent_dept===this.getView().getModel("i18n").getProperty("DEPARTMENT_HEAD")){if(r!==e.RaisedBy){e.Attachment.results.splice(o,1)}}}}this.getView().getModel("worklistView").setProperty("/Accommodation",e);this.getView().getModel("worklistView").setProperty("/Accommodation/Received_Comments","");if(this.getView().getModel("worklistView").getProperty("/sProcessType")==="viewRequest"&&this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")&&this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")!==this.getView().getModel("i18n").getProperty("INITIATOR")&&!this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_role")){return this.oMessage.error(this.getResourceBundle().getText("NOT_AUTHORIZED_WF"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",onClose:function(){}.bind(this),actions:sap.m.MessageBox.Action.OK})}t()}catch(e){this.exceptionErrorNavToMainPage(e);i()}}.bind(this)})}.bind(this))},getAccommodationRelatedDetails:function(e){this.openBusyDialog(this.getResourceBundle().getText("LOADING_REQUESTDETAILS"));this.getView().getModel().read("/AccommodationSet(BusType='',ReqNo='',PayrollNo='')",{filters:[e],urlParameters:{$expand:"Workitem,Workitem/Activity,Comments,Logs,Attachment"},success:function(e){try{this.closeBusyDialog();if(e.ReqNo===this.getView().getModel("worklistView").getProperty("/Accommodation/ReqNo")){if(e.Attachment&&e.Attachment.results){e.Attachment.results.sort(function(e,t){var i=t.Att_txt.split(";")[t.Att_txt.split(";").length-1];var o=t.Att_txt.split(";")[t.Att_txt.split(";").length-2];var r=e.Att_txt.split(";")[t.Att_txt.split(";").length-2];var s=t.Att_txt.split(";")[t.Att_txt.split(";").length-1];return new moment(i+o,"YYYYMMDDHHmmSS").toDate()-new moment(s+r,"YYYYMMDDHHmmSS").toDate()});for(var t=e.Attachment.results.length-1;t>=0;t--){var i=e.Attachment.results[t].Att_txt.split(";")[0].split("(")[1].split(")")[0];if(e.Workitem.Agent_dept===""||e.Workitem.Agent_dept===this.getView().getModel("i18n").getProperty("INITIATOR")||e.Workitem.Agent_dept===this.getView().getModel("i18n").getProperty("DEPARTMENT_HEAD")){if(i!==e.RaisedBy){e.Attachment.results.splice(t,1)}}}}this.getView().getModel("worklistView").setProperty("/Accommodation",e);this.getView().getModel("worklistView").setProperty("/Accommodation/Received_Comments","");if(this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("RE_PARTNER")||this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("RE_PARTNER")){this.getView().getModel("worklistView").setProperty("/Accommodation/ContractStartD",new Date)}else{this.getView().getModel("worklistView").setProperty("/Accommodation/ContractStartD",null)}this.getView().byId("objectLayout").scrollToSection(this.getView().byId("buildingDetails").getId(),500);if(this.getView().getModel("worklistView").getProperty("/sProcessType")==="viewRequest"&&this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")&&this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")!==this.getView().getModel("i18n").getProperty("INITIATOR")&&!this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_role")){return this.oMessage.error(this.getResourceBundle().getText("NOT_AUTHORIZED_WF"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",onClose:function(){this.getOwnerComponent().getRouter().navTo("inbox")}.bind(this),actions:sap.m.MessageBox.Action.OK})}this.resolve()}else{this.reject();return this.oMessage.error(this.getResourceBundle().getText("MSG_INVALID_REQ_FETCHED"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",details:"<p><strong>Solution:</strong></p>\n"+"Please go to main page and try again.."+"<p class='msgSubText'>Please note. User will be navigated back to the main page after this message.</p>",onClose:function(){this.getOwnerComponent().getRouter().navTo("inbox")}.bind(this),actions:sap.m.MessageBox.Action.OK})}}catch(e){this.reject();this.exceptionErrorNavToMainPage(e)}}.bind(this)})},exceptionErrorNavToMainPage:function(e){this.oMessage.error(this.getResourceBundle().getText("errorText"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",details:"<p><strong>Solution:</strong></p>\n"+"Please try again later.."+"<p><strong>Technical Reason:</strong></p>\n"+e.stack.replaceAll(/\n/g,"<br/>")+"<p class='msgSubText'>Please note. User will be navigated back to the main page after this message.</p>",onClose:function(){this.getRouter().navTo("inbox")}.bind(this),actions:sap.m.MessageBox.Action.OK})},onChangeBuilding:function(e){var t,i,o;try{t=e.getParameter("selectedItem");i=t.getBindingContext().getObject().BldngName;o=t.getBindingContext().getObject().BusEntityNo}catch(e){i="";o=""}finally{var r=this.getModel("worklistView");switch(Number(o)){case 100:r.setProperty("/Accommodation/BusType","GD");r.setProperty("/Accommodation/BldngName",i);r.setProperty("/Accommodation/BusEntityNo",o);break;case 101:r.setProperty("/Accommodation/BusType","BS");r.setProperty("/Accommodation/BldngName",i);r.setProperty("/Accommodation/BusEntityNo",o);break;default:r.setProperty("/Accommodation/BldngName","");r.setProperty("/Accommodation/BusEntityNo","");r.setProperty("/Accommodation/BusType","");r.setProperty("/Accommodation/BldngNo","");break}if(i&&o){this.updateRequiredFile();this.fetchingFlatType()}}},updateRequiredFile:function(){var e=this.byId("required_documents_gd").getBinding("items");if(e){e.filter([new this.oFilters({path:"sBuilding",operator:this.oFilterOperator.EQ,value1:this.getModel("worklistView").getProperty("/Accommodation/BldngNo")}),new this.oFilters({and:true,path:"sBusinessEntity",operator:this.oFilterOperator.EQ,value1:this.getModel("worklistView").getProperty("/Accommodation/BusType")})])}var e=this.byId("required_documents_bs").getBinding("items");if(e){e.filter([new this.oFilters({path:"sBuilding",operator:this.oFilterOperator.EQ,value1:this.getModel("worklistView").getProperty("/Accommodation/BldngNo")}),new this.oFilters({and:true,path:"sBusinessEntity",operator:this.oFilterOperator.EQ,value1:this.getModel("worklistView").getProperty("/Accommodation/BusType")})])}},onChangeRentalUnit:function(e){var t=e.getParameters().selectedItem.getText();var i=this.getModel("worklistView");i.setProperty("/Accommodation/RentalObjectText",t)},onChangeFlatType:function(e){var t,i,o;try{t=e.getParameters().selectedItem.getText();i=e.getParameter("selectedItem").getBindingContext("flatType").getModel().getProperty(e.getParameter("selectedItem").getBindingContext("flatType").getPath()).RentPayable;o=e.getParameter("selectedItem").getBindingContext("flatType").getModel().getProperty(e.getParameter("selectedItem").getBindingContext("flatType").getPath()).VariableRent}catch(e){t="";i="";o=""}finally{if(e.getParameters().selectedItem===null){e.getSource().setSelectedItem(0);t=e.getSource().getItemAt(0).getText();i=e.getSource().getItemAt(0).getBindingContext("flatType").getModel().getProperty(e.getSource().getItemAt(0).getBindingContext("flatType").getPath()).RentPayable;o=e.getSource().getItemAt(0).getBindingContext("flatType").getModel().getProperty(e.getSource().getItemAt(0).getBindingContext("flatType").getPath()).VariableRent;var r=this.getModel("worklistView");r.setProperty("/Accommodation/FlatType",e.getSource().getItemAt(0).getKey());r.setProperty("/Accommodation/FlatTypeText",t);r.setProperty("/Accommodation/RentPayable",i);r.setProperty("/Accommodation/VariableRent",o)}else{var r=this.getModel("worklistView");r.setProperty("/Accommodation/FlatTypeText",t);r.setProperty("/Accommodation/RentPayable",i);r.setProperty("/Accommodation/VariableRent",o);this.fetchingRentalUnit()}}},validateAttachment:function(){if(this.getModel("worklistView").getProperty("/Accommodation/Attachment").results.length===0){return false}else{if(this.getModel("worklistView").getProperty("/Accommodation/Attachment").results.length>=2){return true}else{return false}}},onSubmit:function(e){if(this.getModel("Validation").getData().find(function(e){return e.scenario==="ATTACH"&&e.check===true})){if(this.validateAttachment()===false){return this.oMessage.error(this.getResourceBundle().getText("ATTACHMENT_ERROR"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center"})}}if(this.getModel("Validation").getData().find(function(e){return e.scenario==="BUILDING"&&e.check===true})){if(this.validateBuilding()===false){return}}if(this.getModel("Validation").getData().find(function(e){return e.scenario==="FLATYPE"&&e.check===true})){if(this.validateFlatType()===false){return}}if(this.getModel("Validation").getData().find(function(e){return e.scenario==="CONTACT"&&e.check===true})){if(this.validateContacts()===false){return}}if(this.getModel("Validation").getData().find(function(e){return e.scenario==="FAMILY"&&e.check===true})){if(this.validateDependents()===false){return}}if(this.getModel("Validation").getData().find(function(e){return e.scenario==="COSTCNTR"&&e.check===true})){if(this.validateCostCenters()===false){return}}if(this.getModel("Validation").getData().find(function(e){return e.scenario==="VENDOR"&&e.check===true})){if(this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("RE_PARTNER")||this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("RE_PARTNER")){if(this.validateVendor()===false){return}}}this.currentButton=_.clone(e);this.oMessage.confirm(this.formatText(this.getResourceBundle().getText("MSG_MOBEMAIL_INFO",[this.getModel("worklistView").getProperty("/Accommodation/Mobile"),this.getModel("worklistView").getProperty("/Accommodation/Email")])),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",title:"Confirm",onClose:function(e){switch(e){case"CANCEL":this.getView().byId("objectLayout").scrollToSection(this.getView().byId("personalDetails").getId(),1e3);break;case"OK":try{this.proceedSubmit(this.getSubmitData(this.currentButton),this.currentButton);break}catch(e){this.closeBusyDialog();this.exceptionErrorNavToMainPage(e)}}}.bind(this),styleClass:"",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],emphasizedAction:sap.m.MessageBox.Action.OK,initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})},validateMobile:function(e){e=this.byId("mobilePhone")._getInputValue();e=e.replaceAll("_","");e=e.replaceAll("-","");if(e&&(e.startsWith("+971")&&e.length===13||e.startsWith("971")&&e.length===12||e.startsWith("05")&&e.length===10||e.startsWith("5")&&e.length===9)){this.getModel("worklistView").setProperty("/mobileValueState",this.eValueState.None)}else{this.getModel("worklistView").setProperty("/mobileValueState",this.eValueState.Error)}},validateEmail:function(){var e="\\S+@\\S+\\.\\S+";if(this.byId("emailAddress").getValue().match(e)){this.getModel("worklistView").setProperty("/emailValueState",this.eValueState.None);return false}else{this.getModel("worklistView").setProperty("/emailValueState",this.eValueState.Error);return true}},disableValueState:function(e){e.getSource().setValueState(this.eValueState.Error)},validateBuilding:function(){var e=this.getModel("worklistView");if(e.getProperty("/Accommodation/BldngNo")===""){this.oMessage.error(this.getResourceBundle().getText("MSG_BUILDING_ERROR"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",onClose:function(){this.getView().byId("objectLayout").scrollToSection(this.getView().byId("buildingDetails").getId(),500);this.getView().byId("buidingNumber").focus()}.bind(this),actions:sap.m.MessageBox.Action.OK});return false}return true},validateFlatType:function(){var e=this.getModel("worklistView");if(e.getProperty("/Accommodation/FlatType")===""){this.oMessage.error(this.getResourceBundle().getText("MSG_FLATTYPE_ERROR"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",onClose:function(){this.getView().byId("objectLayout").scrollToSection(this.getView().byId("buildingDetails").getId(),500);this.getView().byId("flatTypeCB").focus()}.bind(this),actions:sap.m.MessageBox.Action.OK});return false}return true},validateContacts:function(){var e=this.getModel("worklistView");if(this.validateMobile()&&this.validateEmail()){this.oMessage.error(this.getResourceBundle().getText("MSG_MOBEMAIL_ERROR"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",onClose:function(){this.getView().byId("objectLayout").scrollToSection(this.getView().byId("buildingDetails").getId(),500);this.getView().byId("emailAddress").focus();this.getView().byId("mobilePhone").focus()}.bind(this),actions:sap.m.MessageBox.Action.OK});return false}return true},validateDependents:function(){var e=this.getModel("worklistView");var t=e.getProperty("/Accommodation/DependentsNo");var i=e.getProperty("/Accommodation/FlatType");if(Number(t)===0&&i.indexOf("Y")!==-1){this.oMessage.error(this.getResourceBundle().getText("MSG_DEPENDENTS_ERROR"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center"});return false}return true},validateCostCenters:function(){var e=this.getModel("worklistView");if(e.getProperty("/Accommodation/CostCenter")===""){this.oMessage.error(this.getResourceBundle().getText("MSG_COST_CENTER_ERROR"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center"});return false}return true},validateVendor:function(){var e=this.getModel("worklistView");if(e.getProperty("/Accommodation/VendorNo")===""||e.getProperty("/Accommodation/BPNo")===""){this.oMessage.error(this.getResourceBundle().getText("MSG_VENDOR_BP_ERROR"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center"});return false}return true},constructButtons:function(e,t){var i,o;switch(t.oModel.getProperty(t.getPath()).Activity_desc){case"Approve":i="Accept";o="{= (( ${worklistView>/sProcessType} === 'viewRequest' && ${worklistView>/Accommodation/BusType} === ${i18n>GD} && ${worklistView>/Accommodation/FlatType}.charAt(0) === 'Z' && ${worklistView>/Accommodation/Workitem/Agent_dept} === ${i18n>BUILDING_ADMINISTRATOR} ) ||( ${worklistView>/sProcessType} === 'viewRequest' && ${worklistView>/Accommodation/BusType} === ${i18n>GD} && ${worklistView>/Accommodation/FlatType}.charAt(0) === 'Z' && ${worklistView>/Accommodation/Workitem/Agent_dept} === ${i18n>DEPUTY_MANAGER} ) ||( ${worklistView>/sProcessType} === 'viewRequest' && ${worklistView>/Accommodation/BusType} === ${i18n>GD} && ${worklistView>/Accommodation/FlatType}.charAt(0) === 'Y' && ${worklistView>/Accommodation/Workitem/Agent_dept} === ${i18n>DEPUTY_MANAGER} ) || ( ${worklistView>/sProcessType} === 'viewRequest' && ${worklistView>/Accommodation/BusType} === ${i18n>GD} && ${worklistView>/Accommodation/FlatType}.charAt(0) === 'Y' && ${worklistView>/Accommodation/Workitem/Agent_dept} === ${i18n>DEPUTY_MANAGER} ) || ( ${worklistView>/sProcessType} === 'viewRequest' && ${worklistView>/Accommodation/BusType} === ${i18n>BS} && ${worklistView>/Accommodation/Workitem/Agent_dept} === ${i18n>BUILDING_ADMINISTRATOR} )) ? ( ${worklistView>/Accommodation/RentalObject} !== '' ? true : false ) : ( ${worklistView>/Accommodation/Workitem/Agent_dept} === ${i18n>RE_PARTNER} || ${worklistView>/Accommodation/Workitem/Agent_dept} === ${i18n>RE_PARTNER} ) ? ( ${worklistView>/Accommodation/ContractStartD} !== null ? true : false ) : (( ${worklistView>/sProcessType} === 'viewRequest' && ${worklistView>/Accommodation/Workitem/Agent_dept} !== ${i18n>INITIATOR} && ${worklistView>/Accommodation/Workitem/Agent_dept} !== '' ) ? true : false)  }";break;case"Reject":i="Reject";o="{= ${worklistView>/Accommodation/Workitem} !== undefined && ${worklistView>/Accommodation/Received_Comments} !== ''  ?  true : false }";break;case"Waitlist":i="Reject";o=true;break;case"Clarify":i="Reject";o="{= ${worklistView>/Accommodation/Workitem} !== undefined && ${worklistView>/Accommodation/Received_Comments} !== ''  ?  true : false }";break;case"Withdraw":i="Reject";o=true;break;case"Submit":i="Accept";o="{= ${worklistView>/Accommodation/Workitem} !== undefined && ${worklistView>/Accommodation/Received_Comments} !== ''  ?  true : false }";break;default:o="{= ${worklistView>/Accommodation/Workitem} !== undefined  ?  true : false }";i="Emphasized";break}return new this.oButton({text:t.oModel.getProperty(t.getPath()).Activity_desc,press:this.onApproveRejectWaitlist.bind(this),enabled:o,type:i}).addStyleClass("sapUiTinyMarginBegin")},proceedSubmit:function(e,t){if(e.Attachment.results){for(var i=e.Attachment.results.length;i>0;i--){if(e.Attachment.results[i-1].FileType===""){e.Attachment.results.splice(i-1,1)}}}if(e.Comments.results){for(var i=e.Comments.results.length-1;i>0;i--){if(e.Comments.results[i-1].TDFORMAT==="cmtsEnteredinApplication"){e.Comments.results[i-1].TDFORMAT=":";e.Comments.results.splice(0,i-1);break}}}this.openBusyDialog(this.getResourceBundle().getText("SUBMIT_REQ"));this.getModel().create("/AccommodationSet",e,{success:function(e){try{this.closeBusyDialog();var i;if(this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("INITIATOR")&&t.oSource.getText()===this.getResourceBundle().getText("CLARIFY")){i="Clarified"}else{i=t.oSource.getText()}try{var o=/Android|iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;if(o===true&&window.navigator.notification&&window.navigator.notification.sendLog){window.navigator.notification.sendLog("REFX_UI_ACCOMM::SUCCESS::"+"Accommodation Request '"+e.ReqNo+"' is created successfully!"+"::"+e.ReqNo,null,"","")}}catch{}this.oMessage.success(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText(i,[e.ReqNo]),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",onClose:function(){this.getOwnerComponent().getRouter().navTo("inbox")}.bind(this)})}catch(e){this.closeBusyDialog();try{var o=/Android|iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;if(o===true&&window.navigator.notification&&window.navigator.notification.sendLog){window.navigator.notification.sendLog("REFX_UI_ACCOMM::ERROR::"+e.message+"::"+"",null,"","")}}catch{}this.exceptionErrorNavToMainPage(e)}finally{this.closeBusyDialog()}}.bind(this)})},getSubmitData:function(e){var t=this.getModel("worklistView").getProperty("/Accommodation");if(this.getModel("worklistView").getProperty("/sProcessType")!=="createRequest"){t.Workitem.Activity.results.filter(function(t){return t.Activity_desc===e.oSource.getText()})[0].Final_decision_flg="X"}t.Changed_By=this.getOwnerComponent().getModel("userDetails").getProperty("/loggedInUser/headerDetails/RaisedBy");if(this.getModel("worklistView").getProperty("/sProcessType")==="createRequest"&&e.oSource.getText()===this.getResourceBundle().getText("SUBMIT")){t.Status=this.getResourceBundle().getText("SUBMITTED");t.StatusText=this.getResourceBundle().getText("initiator")+" - "+this.getResourceBundle().getText("SUBMITTED");t.Created_By=this.getOwnerComponent().getModel("userDetails").getProperty("/loggedInUser/headerDetails/RaisedBy");t.RaisedBy=this.getOwnerComponent().getModel("userDetails").getProperty("/loggedInUser/headerDetails/UserID");t.RaisedByPayroll=this.getOwnerComponent().getModel("userDetails").getProperty("/loggedInUser/headerDetails/PayrollNo");t.RaisedByName=this.getOwnerComponent().getModel("userDetails").getProperty("/loggedInUser/headerDetails/PayrollFullName");if(this.getOwnerComponent().getModel("userDetails").getProperty("/changedUser/headerDetails")!==undefined){t.RaisedFor=this.getModel("userDetails").getProperty("/changedUser/headerDetails/UserID");t.RaisedForPayroll=this.getModel("userDetails").getProperty("/changedUser/headerDetails/PayrollNo");t.RaisedForName=this.getModel("userDetails").getProperty("/changedUser/headerDetails/PayrollFullName")}else{t.RaisedFor=this.getModel("userDetails").getProperty("/loggedInUser/headerDetails/UserID");t.RaisedForPayroll=this.getModel("userDetails").getProperty("/loggedInUser/headerDetails/PayrollNo");t.RaisedForName=this.getModel("userDetails").getProperty("/loggedInUser/headerDetails/PayrollFullName")}}else if(this.getModel("worklistView").getProperty("/sProcessType")==="viewRequest"&&e.oSource.getText()===this.getResourceBundle().getText("SUBMIT")&&t.Workitem.Agent_dept===this.getResourceBundle().getText("INITIATOR")){t.Status=this.getResourceBundle().getText("CLARIFIED");t.StatusText=this.getResourceBundle().getText(t.Workitem.Agent_dept.toLowerCase().replace(" ","_"))+" - "+this.getResourceBundle().getText("CLARIFIED")}else if(this.getModel("worklistView").getProperty("/sProcessType")==="viewRequest"&&e.oSource.getText()===this.getResourceBundle().getText("CLARIFY")&&t.Workitem.Agent_dept===this.getResourceBundle().getText("INITIATOR")){t.Status=this.getResourceBundle().getText("CLARIFIED");t.StatusText=this.getResourceBundle().getText(t.Workitem.Agent_dept.toLowerCase().replace(" ","_"))+" - "+this.getResourceBundle().getText("CLARIFIED")}else if(this.getModel("worklistView").getProperty("/sProcessType")==="viewRequest"&&e.oSource.getText()===this.getResourceBundle().getText("WITHDRAW")&&t.Workitem.Agent_dept===this.getResourceBundle().getText("INITIATOR")){t.Status=this.getResourceBundle().getText("WITHDRAW");t.StatusText=this.getResourceBundle().getText(t.Workitem.Agent_dept.toLowerCase().replace(" ","_"))+" - "+this.getResourceBundle().getText("WITHDRAWED")}else if(this.getModel("worklistView").getProperty("/sProcessType")==="viewRequest"&&e.oSource.getText()===this.getResourceBundle().getText("APPROVE")){t.Status=this.getResourceBundle().getText("APPROVED");t.StatusText=this.getResourceBundle().getText(t.Workitem.Agent_dept.toLowerCase().replace(" ","_"))+" - "+this.getResourceBundle().getText("APPROVED")}else if(this.getModel("worklistView").getProperty("/sProcessType")==="viewRequest"&&e.oSource.getText()===this.getResourceBundle().getText("REJECT")){t.Status=this.getResourceBundle().getText("REJECTED");t.StatusText=this.getResourceBundle().getText(t.Workitem.Agent_dept.toLowerCase().replace(" ","_"))+" - "+this.getResourceBundle().getText("REJECTED")}else if(this.getModel("worklistView").getProperty("/sProcessType")==="viewRequest"&&e.oSource.getText()===this.getResourceBundle().getText("WAITLIST")){t.Status=this.getResourceBundle().getText("WAITLISTED");t.StatusText=this.getResourceBundle().getText(t.Workitem.Agent_dept.toLowerCase().replace(" ","_"))+" - "+this.getResourceBundle().getText("WAITLISTED")}else if(this.getModel("worklistView").getProperty("/sProcessType")==="viewRequest"&&e.oSource.getText()===this.getResourceBundle().getText("CLARIFY")){t.Status=this.getResourceBundle().getText("CLARIFY");t.StatusText=this.getResourceBundle().getText(t.Workitem.Agent_dept.toLowerCase().replace(" ","_"))+" - "+this.getResourceBundle().getText("NEEDS_CLARIFICATION")}t=this.postingCommentsInModel(e,t);delete t.Received_Comments;return t},onApproveRejectWaitlist:function(e){this.currentButton=_.clone(e);this.oMessage.confirm(this.formatText(this.getResourceBundle().getText("MSG_CONFIRMING_BEFORE_ACTION",[e.oSource.getText()===this.getResourceBundle().getText("CLARIFY")?"send":e.oSource.getText(),this.getModel("worklistView").getProperty("/Accommodation/ReqNo"),e.oSource.getText()===this.getResourceBundle().getText("CLARIFY")?this.getResourceBundle().getText("for_clarification"):""])),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",title:"Confirm",onClose:function(e){switch(e){case"CANCEL":break;case"OK":try{if(this.getModel("Validation").getData().find(function(e){return e.scenario==="VENDOR"})){if(this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("RE_PARTNER")||this.getView().getModel("worklistView").getProperty("/Accommodation/Workitem/Agent_dept")===this.getResourceBundle().getText("RE_PARTNER")){if(this.validateVendor()===false){return}}}this.proceedSubmit(this.getSubmitData(this.currentButton),this.currentButton);break}catch(e){this.closeBusyDialog();this.exceptionErrorNavToMainPage(e)}}}.bind(this),styleClass:"",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],emphasizedAction:sap.m.MessageBox.Action.OK,initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})},onWithdraw:function(){if(!this.WithdrawDialog){this.WithdrawDialog=this.getDialog("WithdrawDialog")}this.WithdrawDialog.open()},CancelWithdrawDialog:function(){this.WithdrawDialog.close()},Withdraw:function(){if(this.getModel("worklistView").getProperty("/WithdrawComments")===""){this.oMessage.error(this.getResourceBundle().getText("MSG_WITHDRAW_MAND"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center"});return}this.CancelWithdrawDialog();this.oToast.show("Development is in Progress...")},onNavBack:function(){history.go(-1)},onCountyCodeChange:function(e){this.getView().getModel("worklistView").setProperty("/Accommodation/Mobile",e.getSource().getSelectedKey())},refreshModelData:function(){var e=new this.oJson({bAgreement:false,currentDate:new Date,msg:"",WithdrawComments:"",sProcessType:"",mobileValueState:this.eValueState.None,emailValueState:this.eValueState.None,sAgreementDocument:this.getModel("attachmentBasedOnBuilding")&&this.getModel("attachmentBasedOnBuilding").getData().attachmentBasedonBuilding?this.getModel("attachmentBasedOnBuilding").getData().attachmentBasedonBuilding:[]});this.setModel(e,"worklistView");if(this.getModel("flatType")){this.getModel("flatType").setData(null)}},onChange:function(e){var t=e.getSource();var o=new i({name:"x-csrf-token",value:"securityTokenFromModel"});t.addHeaderParameter(o);this.oToast.show("Event change triggered")},onFileView:function(e){try{var t;if(e.getSource().getMetadata().getElementName()==="sap.m.UploadCollectionItem"){t=atob(e.getSource().getCustomData().filter(function(e){return e.mProperties.key==="fileData"})[0].getValue())}else if(e.getSource().getMetadata().getElementName()==="sap.m.ObjectAttribute"){t=atob(e.getSource().getParent().getCustomData().filter(function(e){return e.mProperties.key==="fileData"})[0].getValue())}var i=new Array(t.length);for(var o=0;o<t.length;o++){i[o]=t.charCodeAt(o)}var r=new Uint8Array(i);var s,n;if(e.getSource().getMetadata().getElementName()==="sap.m.UploadCollectionItem"){n=e.getSource().getFileName().split(".")[1]}else if(e.getSource().getMetadata().getElementName()==="sap.m.ObjectAttribute"){n=e.getSource().getParent().getFileName().split(".")[1]}if(n==="PDF"||n==="pdf"){s=new Blob([r],{type:"application/pdf;base64"})}else if(n==="PNG"||n==="png"){s=new Blob([r],{type:"application/pdf;base64"})}else if(n==="docx"||n==="DOCX"||n==="doc"||n==="DOC"){s=new Blob([r],{type:"application/msword;base64"})}else if(n==="jpeg"||n==="JPEG"||n==="jpg"||n==="JPG"){s=new Blob([r],{type:"application/jpeg;base64"})}else if(n==="xls"||n==="XLS"||n==="xlsx"||n==="XLSX"){s=new Blob([r],{type:"application/msexcel"})}else if(n==="txt"||n==="TXT"){s=new Blob([r],{type:"text/plain"})}var a=URL.createObjectURL(s);var l=document.createElement("a");l.href=a;if(e.getSource().getMetadata().getElementName()==="sap.m.UploadCollectionItem"){l.setAttribute("download",e.getSource().getFileName())}else if(e.getSource().getMetadata().getElementName()==="sap.m.ObjectAttribute"){l.setAttribute("download",e.getSource().getParent().getFileName())}document.body.appendChild(l);l.click()}catch(e){this.oMessage.error("Error while retriving the file. Please try again later",{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center"})}},onFileDeleted:function(e){var t=this.getModel("worklistView");var i=t.getData();try{this.currentFileForDelete=e.getSource().getCustomData().filter(function(e){return e.mProperties.key==="path"})[0].getValue()}catch(e){jQuery.sap.log.error(e);return this.oMessage.error("Error occured, Please try again later..",{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center"})}return this.oMessage.confirm(this.getResourceBundle().getText("MSG_CONFIRM_ATTACHMENT_DEL",[i.Accommodation.Attachment.results[this.currentFileForDelete.split("/")[this.currentFileForDelete.split("/").length-1]].FileName,this.getModel("worklistView").getProperty("/Accommodation/ReqNo")]),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center",title:"Confirm",onClose:function(e){switch(e){case"OK":try{i.Accommodation.Attachment.results.splice(this.currentFileForDelete.split("/")[this.currentFileForDelete.split("/").length-1],1);t.setData(i);this.oToast.show("Please make sure to save the request to delete the file permanently..")}catch(e){this.oToast.show("Trouble while deleting the file... Please try again later..")}break;case"CANCEL":break}}.bind(this),styleClass:"",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],emphasizedAction:sap.m.MessageBox.Action.OK,initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})},onFilenameLengthExceed:function(){this.oToast.show("Event filenameLengthExceed triggered")},onFileSizeExceed:function(){this.oToast.show("Maximum file size allowed per file is 5 MB.")},onTypeMissmatch:function(){this.oMessage.error(this.getResourceBundle().getText("UPLOAD_MISMATCH"),{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center"})},formatter_UploadedOn:function(e){return new moment(e.split(";")[1]+e.split(";")[2],"YYYYMMDDHHmmSS").format("MMM DD, yyyy h:mm:ss a")},factory_attachments:function(e,t){if(t){if(t.getModel().getProperty(t.getPath()).Docid){var i="/sap/opu/odata/sap/ZREFX_GD_ACCOMMODATION_SRV/getDocumentsSet(Docid='"+t.getModel().getProperty(t.getPath()).Docid+"')/$value"}return new o({deletePress:this.onFileDeleted.bind(this),url:i,fileName:t.getModel().getProperty(t.getPath()).FileName,customData:[new this.oCustomData({key:"fileData",value:t.getModel().getProperty(t.getPath()).Att_bin}),new sap.ui.core.CustomData({key:"path",value:t.getPath()})],attributes:[new r({title:"Uploaded By",text:t.getModel().getProperty(t.getPath()).Att_txt.split(";")[0]}),new r({title:"Uploaded On",text:{path:"worklistView>Att_txt",formatter:this.formatter_UploadedOn}}),new r({title:"",visible:t.getModel().getProperty(t.getPath()).Att_bin!=="",text:"Delete",active:true,customData:new sap.ui.core.CustomData({key:"path",value:t.getPath()}),press:this.onFileDeleted.bind(this)}).addStyleClass("redFont")]})}},factory_attachments_initiator:function(e,t){return new o({deletePress:this.onFileDeleted.bind(this),press:this.onFileView.bind(this),fileName:window.fnArraylastEntry(t.getModel().getProperty(t.getPath()).sFilePath.split("/")),attributes:[new r({text:window.fnArraylastEntry(t.getModel().getProperty(t.getPath()).sDocumentDetails.split("/"))}),new r({text:"Upload completed form ⇯",active:true,press:this.onViewDocument.bind(this)}),new r({text:"Replace completed form ⤮",active:true,press:this.onViewDocument.bind(this)}),new r({active:true,text:"fileuploaded.pdf ☑"})]})},onViewDocumentClose:function(e){try{e.getSource().getParent().close()}catch(t){e.getSource().getParent().getParent().close()}},onViewDocument:function(e){try{var t;if(e.getSource().getMetadata().getElementName()==="sap.m.UploadCollectionItem"){t=atob(e.getSource().getCustomData().filter(function(e){return e.mProperties.key==="fileData"})[0].getValue())}else if(e.getSource().getMetadata().getElementName()==="sap.m.ObjectAttribute"){t=atob(e.getSource().getParent().getCustomData().filter(function(e){return e.mProperties.key==="fileData"})[0].getValue())}var i=new Array(t.length);for(var o=0;o<t.length;o++){i[o]=t.charCodeAt(o)}var r=new Uint8Array(i);var s,n;if(e.getSource().getMetadata().getElementName()==="sap.m.UploadCollectionItem"){n=e.getSource().getFileName().split(".")[1]}else if(e.getSource().getMetadata().getElementName()==="sap.m.ObjectAttribute"){n=e.getSource().getParent().getFileName().split(".")[1]}if(n==="PDF"||n==="pdf"){s=new Blob([r],{type:"application/pdf;base64"})}else if(n==="PNG"||n==="png"){s=new Blob([r],{type:"application/pdf;base64"})}else if(n==="docx"||n==="DOCX"||n==="doc"||n==="DOC"){s=new Blob([r],{type:"application/msword;base64"})}else if(n==="jpeg"||n==="JPEG"||n==="jpg"||n==="JPG"){s=new Blob([r],{type:"application/jpeg;base64"})}else if(n==="xls"||n==="XLS"||n==="xlsx"||n==="XLSX"){s=new Blob([r],{type:"application/msexcel"})}else if(n==="txt"||n==="TXT"){s=new Blob([r],{type:"text/plain"})}var a=URL.createObjectURL(s);var l=this.getDialog("ViewDocument");var g=window.open(a,"","width=800,height=500");g.print()}catch(e){this.oMessage.error("Error while retriving the file. Please try again later",{horizontalScrolling:false,verticalScrolling:true,titleAlignment:"Center"})}},fileURL:function(e){return'<div><iframe title="description" style="height: 100vh;" src="https://docs.google.com/viewer?url='+e+'&embedded=true"></iframe></div>'},onChangeOnfile:function(e){var t=new FileReader;t.readAsDataURL(e.getParameter("files")[0]);this._fileReaderHeader=e.getParameter("files")[0];t.onload=function(e){var t=this.getModel("worklistView");var i=t.getData();if(i.Accommodation.Attachment.results===undefined){i.Accommodation.Attachment.results=[]}var o=e.srcElement.result.split(",").pop();var r=e.total/1024;var s=r/1024;var n;if(s>1){n=s+" Mb"}else{n=r+" Kb"}i.Accommodation.Attachment.results.push({BusType:i.Accommodation.BusType,ReqNo:i.Accommodation.ReqNo,PayrollNo:i.Accommodation.PayrollNo,FileType:this._fileReaderHeader.type,FileName:this._fileReaderHeader.name,FileExt:this._fileReaderHeader.name.split(".")[1],Language:"EN",Att_txt:this.getModel("userDetails").getProperty("/loggedInUser/headerDetails/PayrollFullName")+";"+(new moment).format("YYYYMMDD")+";"+(new moment).format("HHmmSS"),Att_bin:o});t.setData(i);this._fileReaderHeader=undefined}.bind(this)}})});